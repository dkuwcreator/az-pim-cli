# ADR 0001: Authentication Strategy

## Status

Accepted

## Context

The az-pim-cli needs to authenticate with Azure services to interact with Privileged Identity Management (PIM) APIs. There are multiple authentication methods available, and we need a deterministic, reliable strategy that works for both local development and automation scenarios.

### Requirements

1. **Local Development**: Developers should be able to use their existing Azure CLI login
2. **Automation**: Support service principals and managed identities for CI/CD
3. **Security**: Never store credentials in the CLI itself
4. **Simplicity**: Minimize authentication complexity for end users
5. **Reliability**: Avoid authentication-related failures and confusion

### API Scopes Needed

The CLI interacts with two different Azure APIs:

- **Microsoft Graph API**: For Entra ID (Azure AD) roles
  - Scope: `https://graph.microsoft.com/.default`
  - Permissions: `RoleManagement.ReadWrite.Directory`, `RoleAssignmentSchedule.ReadWrite.Directory`

- **Azure Resource Manager (ARM) API**: For Azure resource roles
  - Scope: `https://management.azure.com/.default`
  - Permissions: Standard Azure RBAC permissions at the resource scope

## Decision

We will implement a **two-phase authentication strategy**:

### Phase 1 (Current - Ship Fast): Azure CLI Token Source

**Primary Method**: Use Azure Identity SDK's `AzureCliCredential`

- Leverages existing `az login` session
- No additional authentication required
- Works with all Azure CLI authentication methods (user, service principal, managed identity)
- Fully supported by Microsoft Azure Identity SDK

**Implementation**:
```python
from azure.identity import AzureCliCredential

credential = AzureCliCredential()
token = credential.get_token("https://graph.microsoft.com/.default")
```

**Fallback**: `DefaultAzureCredential` for non-Azure CLI environments

- Tries multiple credential types in order: environment variables, managed identity, Azure CLI, etc.
- Provides automatic support for service principals and managed identities

**Reference**: https://learn.microsoft.com/en-us/python/api/azure-identity/azure.identity.azureclicredential

### Phase 2 (Future - Optional): MSAL Device Code Flow

**Purpose**: Support environments where Azure CLI is not available

**Method**: Use MSAL Python with device code flow

- Interactive authentication for CLI-style applications
- User-friendly for environments without browser access
- Feature-flagged and opt-in

**Implementation** (future):
```python
from msal import PublicClientApplication

app = PublicClientApplication(
    client_id="{app-id}",
    authority="https://login.microsoftonline.com/organizations"
)

flow = app.initiate_device_flow(scopes=["https://graph.microsoft.com/.default"])
print(flow["message"])  # User visits URL and enters code

result = app.acquire_token_by_device_flow(flow)
token = result["access_token"]
```

**Activation**: Via environment variable or config flag:
```bash
export AZ_PIM_AUTH_MODE=device_code
```

**Reference**: 
- https://learn.microsoft.com/en-us/entra/identity-platform/msal-authentication-flows
- https://learn.microsoft.com/en-us/entra/msal/python/

## Credential Chain

The authentication flow follows this precedence:

1. **Azure CLI Credential** (`AzureCliCredential`)
   - Requires: `az login` completed
   - Best for: Local development
   
2. **Default Azure Credential** (`DefaultAzureCredential`)
   - Tries in order:
     - Environment variables (`AZURE_CLIENT_ID`, `AZURE_CLIENT_SECRET`, `AZURE_TENANT_ID`)
     - Managed Identity
     - Azure CLI (if available)
     - Azure PowerShell (if available)
   - Best for: Automation, CI/CD pipelines

3. **MSAL Device Code** (Phase 2 - future, opt-in only)
   - Requires: User interaction with browser
   - Best for: Environments without Azure CLI

## Required Scopes and Permissions

### For Entra ID (Azure AD) Role Operations

**Scope**: `https://graph.microsoft.com/.default`

**Delegated Permissions** (for user context):
- `RoleAssignmentSchedule.ReadWrite.Directory` - Required for activating roles
- `RoleEligibilitySchedule.Read.Directory` - Required for listing eligible roles
- `RoleManagement.Read.Directory` - Required for reading role metadata

**Application Permissions** (for service principal context):
- `RoleManagement.ReadWrite.Directory` - For automation scenarios

**Minimum Role in Tenant**:
- User must have eligible PIM role assignments to activate roles
- Privileged Role Administrator role required for approval operations

### For Azure Resource Role Operations

**Scope**: `https://management.azure.com/.default`

**Azure RBAC Permissions** (at resource scope):
- `Microsoft.Authorization/roleEligibilityScheduleInstances/read` - List eligible roles
- `Microsoft.Authorization/roleAssignmentScheduleRequests/write` - Activate roles
- `Microsoft.Authorization/roleAssignmentScheduleInstances/read` - List active assignments

**Notes**:
- No Graph API permissions required for resource roles
- Permissions are scope-specific (subscription, resource group, or resource)
- User must have eligible role assignments at the target scope

## Token Caching

- Tokens are cached by the Azure Identity SDK
- Cache location: SDK-managed (typically in user's home directory)
- No custom caching implementation needed
- Tokens automatically refreshed when expired

## Error Handling

### Authentication Errors

**Scenario**: No credentials available
- **Error**: "No Azure credentials available"
- **Action**: Prompt user to run `az login` or configure Azure SDK credentials

**Scenario**: Token expired
- **Error**: "Token expired"
- **Action**: Automatically refresh token using credential chain

**Scenario**: Insufficient permissions
- **Error**: "Insufficient permissions" (403)
- **Action**: Display required permissions and suggest granting consent

### Implementation

```python
class AuthenticationError(Exception):
    def __init__(self, message: str, suggestion: str = ""):
        self.message = message
        self.suggestion = suggestion

try:
    credential = AzureCliCredential()
    token = credential.get_token("https://graph.microsoft.com/.default")
except Exception as e:
    raise AuthenticationError(
        "No Azure credentials available",
        suggestion="Run 'az login' to authenticate with Azure CLI"
    )
```

## Configuration

### Environment Variables

- `AZ_PIM_AUTH_MODE` - Override auth mode (future use)
  - Values: `azurecli` (default), `device_code` (future)
  
- `AZURE_CLIENT_ID`, `AZURE_CLIENT_SECRET`, `AZURE_TENANT_ID` - Service principal auth
  - Used by `DefaultAzureCredential` automatically

### Config File

No authentication configuration in config file (security best practice).

## Consequences

### Positive

1. **Simple for users**: Works out of the box with `az login`
2. **Secure**: No credential storage in CLI code or config
3. **Flexible**: Supports multiple authentication methods via Azure SDK
4. **Maintainable**: Leverages Microsoft's supported SDKs
5. **Future-proof**: Easy to add MSAL device code later

### Negative

1. **Azure CLI dependency**: Phase 1 requires Azure CLI to be installed
2. **Limited control**: Relies on Azure SDK implementation
3. **Token format**: Cannot easily customize token claims or lifetime

### Mitigations

- Phase 2 will add MSAL device code for non-Azure CLI environments
- Documentation clearly states Azure CLI requirement
- `DefaultAzureCredential` provides fallback for automation scenarios

## Alternatives Considered

### MSAL as Primary Method

**Rejected**: Adds complexity for local development users who already use `az login`

**Reasoning**: Most PIM users are developers/operators who have Azure CLI installed

### Custom Token Storage

**Rejected**: Security risk and maintenance burden

**Reasoning**: Azure SDK provides secure token caching; reimplementing it adds risk

### Interactive Browser Flow

**Rejected**: Doesn't work in all terminal environments

**Reasoning**: Device code flow is more compatible with CLI usage patterns

## References

- Azure Identity SDK: https://learn.microsoft.com/en-us/python/api/azure-identity/azure.identity
- AzureCliCredential: https://learn.microsoft.com/en-us/python/api/azure-identity/azure.identity.azureclicredential
- DefaultAzureCredential: https://learn.microsoft.com/en-us/python/api/azure-identity/azure.identity.defaultazurecredential
- MSAL Python: https://learn.microsoft.com/en-us/entra/msal/python/
- Device Code Flow: https://learn.microsoft.com/en-us/entra/identity-platform/msal-authentication-flows

## Change History

- **2024-12-22**: Initial version - Phase 1 authentication strategy defined
